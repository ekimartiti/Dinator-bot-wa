# Inworld Node.js SDK

Below we will describe how to set up our virtual character integration package for **Node.js**. Note that this package has TypeScript support.

## Installation

Node 16 is recommended. The exact set of compatible Node versions can be found in the `engines` field of the `package.json` file.

```sh
npm install @inworld/nodejs-sdk
```
or
```sh
yarn add @inworld/nodejs-sdk
```

## Usage

### Say hello

Use the following code to say "Hello" to your character.

```typescript
import {
  InworldClient,
  InworldPacket,
} from '@inworld/nodejs-sdk';

async function sayHello() {
  const client = new InworldClient()
    // Get key and secret from the integrations page.
    .setApiKey({
      key: process.env.INWORLD_KEY!,
      secret: process.env.INWORLD_SECRET!,
    })
    // Setup a user name.
    // It allows character to call you by name.
    .setUser({ fullName: 'Your name' })
    // Setup required capabilities.
    // In this case you can receive character emotions.
    .setConfiguration({
      capabilities: { audio: true, emotions: true },
    })
    // Use a full character name.
    // It should be like workspaces/{WORKSPACE_NAME}/characters/{CHARACTER_NAME}.
    // Or like workspaces/{WORKSPACE_NAME}/scenes/{SCENE_NAME}.
    .setScene(process.env.INWORLD_SCENE!)
    // Attach handlers
    .setOnError((err: Error) => console.error(err))
    .setOnMessage((msg: InworldPacket) => {
      console.log(msg);

      // Close connection.
      connection.close();
    });

  // Finish connection configuration.
  const connection = client.build();

  // Send your message to a character.
  await connection.sendText('Hello');
}

sayHello();
```
### Generate token only

```typescript
import { InworldClient } from '@inworld/nodejs-sdk';

const run = async function () {
  const token = await getToken();

  // Use token here...
};

const getToken = async function() {
  // Get key and secret from the integrations page.
  const client = new InworldClient()
    .setApiKey({
      key: process.env.INWORLD_KEY,
      secret: process.env.INWORLD_SECRET,
    });

  return client.generateSessionToken();
}

run();
```
More examples can be found in the **examples** folder.

## API

### Capabilities configuration

```typescript
const capabilities = new Capabilities({ emotions: true });
```

|Name|Description|Default value|
|--:|--:|--:|
|audio|If **false*, then the client will not receive spoken audio from the characters (text only mode). |true|
|emotions|You will receive character emotions. |false|

### Connection configuration

```typescript
const connection = {
  disconnectTimeout: 10 * 1000, // time in milliseconds
  autoReconnect: false, // true by default
}
```

|Name|Description|Default value|
|--:|--:|--:|
|disconnectTimeout|Close connection due to inactivity|60000|
|autoReconnect|Connection will be opened automatically on send if it is closed. Otherwise an existing open connection will be used. Our server closes the connection automatically after 1 minute of inactivity.|true|

### SessionToken

```typescript
const token = client.generateSessionToken();

// Get a token.
token.getToken();

// Get type (Bearer).
token.getType();

// Get expiration time.
// Token should be regenerated after expiration time.
token.getExpirationTime();

// Get session id.
token.getSessionId();
```

### InworldClient

```typescript
const client = new InworldClient();

// ApiKey is required.
client.setApiKey({ key, secret });

// User is not required.
client.setUser(user);

// Configuration is not required.
client.setConfiguration({
  capabilities,
  connection: {
    disconnectTimeout: 10 * 1000, // time in milliseconds
    autoReconnect: false,
  }
});

// Scene is not required for token generation.
// But if you would like to speak with scene characters you need to provide scene full name.
// It should be like workspaces/{WORKSPACE_NAME}/characters/{CHARACTER_NAME}.
// Or like workspaces/{WORKSPACE_NAME}/scenes/{SCENE_NAME}.
client.setScene(scene);

// Event handlers
client.setOnDisconnect(fn);
client.setOnError(fn);
client.setOnMessage(fn);

// Generate SessionAccessToken.
client.generateSessionToken();

// Finish connection configuration.
// Return instance of EventService.
// Ð¡onnection is not open. It's just ready to open on message send.
const connection = client.build();
```

### InworldConnectionService

```typescript
const connection = client.build();

// Open connection manually. Available only if configuration.connection.autoReconnect = false.
// Otherwise connection will be managed automatically by SDK.
connection.open();

// You can check if the connection is open or not in case of configuration.connection.autoReconnect = false.
connection.isActive();

// Send text message.
const sendPacket = connection.sendText(message);

// Send custom event. Pass event name as parameter.
const sendPacket = connection.sendCustom(name);

// Send audio start event before call sendAudio.
const sendPacket = connection.sendAudioSessionStart();

// Send audio end event after all audio chunks you would like to send.
const sendPacket = connection.sendAudioSessionEnd();

// Send audio. Pass string chuck as parameter.
const sendPacket = connection.sendAudio(chunk);

// Send a cancel response.
const sendPacket = connection.sendCancelResponse();

// Close connection.
connection.close();

// Get a character list.
connection.getCharacters();

// Get the current character.
connection.getCurrentCharacter();

// Change character in the scene.
connection.setCurrentCharacter(character);
```

### Character

```typescript
const character = connection.getCurrentCharacter();

// Character id.
character.getId();

// Character resource name.
character.getResourceName();

// Character display name.
character.getDisplayName();
```

### InworldPacket

```typescript
client.setOnMessage((packet: InworldPacket) => {...});

// ISO string.
packet.date

// It's a text event.
packet.isText()

// Get message of text event.
packet.text.text
packet.text.final

// Get emotions.
packet.emotion.joy
packet.emotion.fear
packet.emotion.trust
packet.emotion.surprise

// Get behavior affected by emotions.
packet.emotion.behavior.isNeutral()
packet.emotion.behavior.isDisgust()
packet.emotion.behavior.isContempt()
packet.emotion.behavior.isBelligerence()
packet.emotion.behavior.isDomineering()
packet.emotion.behavior.isCriticism()
packet.emotion.behavior.isAnger()
packet.emotion.behavior.isAnger()
packet.emotion.behavior.isTension()
packet.emotion.behavior.isTenseHumor()
packet.emotion.behavior.isDefensiveness()
packet.emotion.behavior.isWhining()
packet.emotion.behavior.isSadness()
packet.emotion.behavior.isStonewalling()
packet.emotion.behavior.isInterest()
packet.emotion.behavior.isValidation()
packet.emotion.behavior.isAffection()
packet.emotion.behavior.isHumor()
packet.emotion.behavior.isSurprise()
packet.emotion.behavior.isJoy()

// Get strength of the emotion.
packet.emotion.strength.isWeak()
packet.emotion.strength.isStrong()

// It's an audio event.
packet.isAudio()

// Get chunck of audio event.
packet.audio.chuck

// It's a custom event.
packet.isCustom()

// It's an emotion event.
packet.isEmotion()

// It's a control event.
packet.isControl()

// It's a special control event. It means that interaction ends.
packet.isInteractionEnd();
```

### Error handling
```typescript
import {
  status,
} from '@inworld/nodejs-sdk';

handleError(err: ServiceError) {
  switch (err.code) {
    // Cancelled by server due timeout inactivity.
    case status.ABORTED:
    // Cancelled by client.
    case status.CANCELLED:
      break;
    default:
      console.error(err);
      break;
  }
```

You can read more about states [here](https://grpc.github.io/grpc/core/md_doc_statuscodes.html).

## ENVIRONMENT

Use these environment variables for local debugging of the package.

|Name|Description|Deafult value|
|--:|--:|--:|
|NODE_SDK_INWORLD_STUDIO_HOST|Studio host|api-studio.inworld.ai:443|
|NODE_SDK_INWORLD_STUDIO_SSL|Define Studio connection will be secure or not|true|
|NODE_SDK_INWORLD_ENGINE_HOST|Engine host|api-engine.inworld.ai:443|
|NODE_SDK_INWORLD_ENGINE_SSL|Define Engine connection will be secure or not|true|

## Licence

https://www.inworld.ai/sdk-license
